<!DOCTYPE html>
<html xmlns:th="http://www.thymeleaf.org">
<head>
    <meta charset="UTF-8">
    <title th:text="${pageTitle}"></title>
    <th:block th:replace="~{admin/layouts/_header::link-css}"></th:block>
</head>
<body>
<div th:replace="~{admin/layouts/_header :: header}"></div>
<div class="content-wrapper">
    <div class="container">
        <h1>Quản lý Sản phẩm</h1>

        <form id="searchForm" method="get">
            <div class="form-group">
                <input type="text" class="form-control" name="searchString" placeholder="Tìm kiếm tin tức">
            </div>
            <button type="submit" class="btn btn-primary">Tìm kiếm</button>
        </form>
        <div class="card-tools">
            <a href="#" class="btn btn-danger" id="BtnDeleteAll">Xóa</a>
        </div>
        <div class="card-tools">
            <a href="/admin/product/add" class="btn btn-primary" >Thêm mới</a>
        </div>
        <table id="newsTable" class="table table-hover">
            <thead>
            <tr>
                <th><input type="checkbox" id="SelectAll"></th>
                <th>STT</th>
                <th>Hình ảnh</th>
                <th>Tên tin tức</th>
                <th>Loại sản phẩm</th>
                <th>Nhà cung cấp</th>
                <th>Số lượng</th>
                <th>Ngày tạo</th>
                <th>Home</th>
                <th>Sale</th>
                <th>Hot</th>
                <th></th>
            </tr>
            </thead>
            <tbody></tbody>
        </table>

        <div class="row">
            <div class="col-6"></div>
            <div class="col-6" style="text-align: right;">
                <ul id="pagination" class="pagination"></ul>
            </div>
        </div>
    </div>
</div>
<div th:replace="~{admin/layouts/_footer :: footer}"></div>
<script>
    $(document).ready(function () {
        var currentPage = 1;

        function loadNews(pageNumber = 1, searchString = "") {
            $.ajax({
                url: 'http://localhost:2009/api/products/paginate',
                type: 'GET',
                data: {
                    page: pageNumber,
                    searchString: searchString,
                    isActivate: false
                },
                success: function (response) {
                    var news = response.data;
                    var totalPages = response.totalPages;
                    var tableBody = $('#newsTable tbody');
                    tableBody.empty();

                    if (news.length > 0) {
                        var i = ((pageNumber - 1) * 10) + 1;
                        news.forEach(function (item) {
                            var strCheckHome = item.home ? "<i class='fa fa-check text-success'></i>" : "<i class='fas fa-times text-danger'></i>";
                            var strCheckSale = item.sale ? "<i class='fa fa-check text-success'></i>" : "<i class='fas fa-times text-danger'></i>";
                            var strCheckHot = item.hot ? "<i class='fa fa-check text-success'></i>" : "<i class='fas fa-times text-danger'></i>";
                            var row = $('<tr id="trow_'+item.id+'">');
                            row.append('<td><input type="checkbox" class="cbkItem" value="'+item.id+'" /></td>');
                            row.append('<td>' + i + '</td>');
                            row.append('<td><img class="img-thumbnail" src="/images/' + item.image + '" alt="Hình ảnh" width="100"></td>');
                            row.append('<td>' + item.title + '</td>');
                            row.append('<td id="category_' + item.id + '"></td>');
                            row.append('<td id="supplier_' + item.id + '"></td>');
                            row.append('<td>' + item.quantity + '</td>');
                            row.append('<td>' + formatDate(item.createdDate) + '</td>');
                            row.append('<td>' + strCheckHome + '</td>');
                            row.append('<td>' + strCheckSale + '</td>');
                            row.append('<td>' + strCheckHot + '</td>');
                            row.append('<td>' +
                                '<a style="margin-right:5px;" href="/admin/product/edit/' + item.id + '" class="btn btn-sm btn-primary">Sửa</a>' +
                                '<a href="#" data-id="' + item.id + '" class="btn btn-sm btn-danger btnDelete">Xóa</a>' +
                                '</td>');
                                tableBody.append(row);
                            i++;

                            // Gọi API để lấy tên của category
                            $.ajax({
                                url: 'http://localhost:2009/api/product-categories/' + item.productCategoryId,
                                type: 'GET',
                                success: function (response) {
                                    var categoryName = response.title;
                                    $('#category_' + item.id).text(categoryName);
                                },
                                error: function (xhr, textStatus, error) {
                                    console.log(xhr.responseText);
                                }
                            });
                            // Gọi API để lấy tên của category
                            $.ajax({
                                url: 'http://localhost:2009/api/suppliers/' + item.supplierId,
                                type: 'GET',
                                success: function (response) {
                                    var categoryName = response.title;
                                    $('#supplier_' + item.id).text(categoryName);
                                },
                                error: function (xhr, textStatus, error) {
                                    console.log(xhr.responseText);
                                }
                            });
                        });
                    } else {
                        tableBody.append('<tr><td colspan="10" class="text-center">Không tìm thấy tin tức nào.</td></tr>');
                    }

                    updatePagination(totalPages, pageNumber, searchString);
                },
                error: function (xhr, textStatus, error) {
                    console.log(xhr.responseText);
                }
            });
        }
        function formatDate(dateString) {
                    var date = new Date(dateString);
                    var day = date.getDate();
                    var month = date.getMonth() + 1;
                    var year = date.getFullYear();

                    // Đảm bảo định dạng ngày và tháng có hai chữ số
                    if (day < 10) {
                        day = '0' + day;
                    }
                    if (month < 10) {
                        month = '0' + month;
                    }

                    return day + '/' + month + '/' + year;
                }
        function updatePagination(totalPages, currentPage, searchString) {
            var pagination = $('#pagination');
            pagination.empty();

            for (var i = 1; i <= totalPages; i++) {
                var pageLink = $('<li class="page-item">');
                if (i === currentPage) {
                    pageLink.addClass('active');
                }
                pageLink.append('<a class="page-link" href="#">' + i + '</a>');
                pagination.append(pageLink);
            }

            // Lắng nghe sự kiện click trên các liên kết phân trang
            pagination.find('.page-link').click(function(e) {
                e.preventDefault();
                var pageNumber = parseInt($(this).text());
                loadNews(pageNumber, searchString);
            });
        }
    $('#searchForm').submit(function (e) {
                e.preventDefault();
                var searchString = $('input[name="searchString"]').val();
                loadNews(1, searchString);
            });


        loadNews(currentPage);
    });
    $(document).ready(function () {
        $('body').on('click', '#BtnDeleteAll', function (e) {
            e.preventDefault();
            var str = "";
            var checkbox = $('#newsTable').find('tbody tr td input:checkbox');
            var i = 0;
            checkbox.each(function () {
                if (this.checked) {
                    var _id = $(this).val();
                    if (i === 0) {
                        str += _id;
                    } else {
                        str += "," + _id;
                    }
                    i++;
                } else {
                    checkbox.attr('selected', '');
                }
            });
            if (str.length > 0) {
                var conf = confirm('Bạn có muốn xóa các bản ghi này hay không?');
                if (conf === true) {
                    $.ajax({
                        url: 'http://localhost:2009/api/products/deleteAll',
                        type: 'POST',
                        data: { ids: str },
                        success: function () {
                                location.reload();
                            }
                    });
                }
            }
        });
        $('body').on('change', '#SelectAll', function () {
            var checkStatus = this.checked;
            var checkbox = $('#newsTable').find('tbody tr td input:checkbox');
            checkbox.each(function () {
                this.checked = checkStatus;
                if (this.checked) {
                    checkbox.attr('selected', 'checked');
                } else {
                    checkbox.attr('selected', '');
                }
            });
        });
        $('body').on('click', '.btnDelete', function () {
            var id = $(this).data("id");
            var conf = confirm('Bạn có muốn xóa bản ghi này không?');
            if (conf === true) {
                $.ajax({
                        url: 'http://localhost:2009/api/products/delete/'+ id,
                        type: 'DELETE',
                        success: function () {
                            // Xóa hàng trong bảng
                            $('#trow_' + id).remove();
                        },
                    });
            }
        });
    });
</script>
</body>
</html>
