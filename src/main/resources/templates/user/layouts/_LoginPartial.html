<div th:fragment="LoginPartial" xmlns:th="http://www.thymeleaf.org">
    <div th:if="${#httpServletRequest.isUserInRole('ROLE_USER')}">
        <form th:action="@{/logout}" id="logoutForm" class="navbar-right" method="post">
            <input type="hidden" th:name="${_csrf.parameterName}" th:value="${_csrf.token}" />
            <ul class="nav navbar-nav navbar-right">
                <li>
                    <span th:with="context=${#httpServletRequest.getUserPrincipal()}"></span>
                    <span th:with="id=${context.name}"></span>
                    <span th:with="find=${@yourUserRepository.findById(id).orElse(null)}"></span>
                    <span th:if="${find != null}">
                        <a th:href="@{/update}" class="rd-nav-link" th:title="Manage">
                            <h1 id="username"></h1>
                        </a>
                    </span>
                </li>
                <li><a href="javascript:document.getElementById('logoutForm').submit()">Đăng Xuất</a></li>
            </ul>
        </form>
    </div>

    <!-- If not authenticated -->
    <div th:unless="${#httpServletRequest.isUserInRole('ROLE_USER')}">
        <ul class="nav navbar-nav navbar-right">
            <li>
                <a th:href="@{/register}" id="registerLink">Đăng Ký</a>
            </li>
            <li>
                <a th:href="@{/login}" id="loginLink">Đăng Nhập</a>
            </li>
        </ul>
    </div>

    <script>
        // Lấy giá trị token từ localStorage
        var accessToken = localStorage.getItem("accessToken");

        // Gọi API hoặc sử dụng hàm giải mã token đã được định nghĩa để lấy thông tin username
        var decodedToken = parseJwt(accessToken);
        var username = decodedToken.sub; // Thay "sub" bằng trường chứa username trong token của bạn

        // Hiển thị username trong thẻ h1 có id "username"
        var usernameElement = document.getElementById("username");
        usernameElement.textContent = "Xin chào, " + username;

        // Hàm giải mã token
        function parseJwt(token) {
            var base64Url = token.split(".")[1];
            var base64 = base64Url.replace(/-/g, "+").replace(/_/g, "/");
            var jsonPayload = decodeURIComponent(atob(base64).split("").map(function (c) {
                return "%" + ("00" + c.charCodeAt(0).toString(16)).slice(-2);
            }).join(""));

            return JSON.parse(jsonPayload);
        }
    </script>
</div>
